name: Windows-RDP-Fixed-Path

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart_rdp]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: 1. Instalare Ngrok + MEGAcmd
      shell: pwsh
      run: |
        choco install ngrok megacmd -y
        refreshenv

        Write-Host "Verificare MEGAcmd in PATH..."
        where.exe mega-cmd || exit 1

    - name: 2. Restaurare Date MEGA (auto-detect)
      shell: pwsh
      run: |
        $megaCmd = (Get-Command mega-cmd.exe -ErrorAction SilentlyContinue).Source

        if (!$megaCmd) {
          Write-Error "MEGAcmd nu este in PATH"
          exit 1
        }

        Write-Host "MEGAcmd gasit la: $megaCmd"

        & $megaCmd login ${{ secrets.MEGA_EMAIL }} ${{ secrets.MEGA_PASSWORD }}

        if (!(Test-Path "C:\RDP_Work")) {
          New-Item -Path "C:\RDP_Work" -ItemType Directory
        }

        & $megaCmd get /RDP_Backup C:\RDP_Work

        Write-Host "Restaurare finalizata."

    - name: 3. Configurare RDP + Ngrok
      shell: pwsh
      run: |
        Set-ItemProperty `
          -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
          -Name "fDenyTSConnections" `
          -Value 0

        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        net user runneradmin ParolaRDP123! /add
        net localgroup administrators runneradmin /add

        $ngrok = (Get-Command ngrok.exe).Source
        & $ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

        Start-Process $ngrok -ArgumentList "tcp 3389"

    - name: 4. Afisare RDP + Auto Backup
      shell: pwsh
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        Start-Sleep -Seconds 30

        $tunnels = Invoke-RestMethod http://localhost:4040/api/tunnels

        Write-Host "=========================================="
        Write-Host "ADRESA RDP: $($tunnels.tunnels[0].public_url)"
        Write-Host "USER: runneradmin"
        Write-Host "PAROLA: ParolaRDP123!"
        Write-Host "=========================================="

        $megaCmd = (Get-Command mega-cmd.exe).Source
        $count = 0

        while ($count -lt 18) {
          Start-Sleep -Seconds 600
          & $megaCmd put -c C:\RDP_Work /RDP_Backup
          $count++
        }

        gh api repos/${{ github.repository }}/dispatches -f event_type=restart_rdp

name: Windows-RDP-Fixed-Path

on:
  workflow_dispatch:
  repository_dispatch:
    types: [restart_rdp]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
      actions: write

    steps:
    - name: 1. Instalare Ngrok + MEGAcmd
      run: |
        choco install ngrok megacmd -y
        refreshenv

    - name: 2. Restaurare Date MEGA (cale corecta)
      shell: pwsh
      run: |
        $mega = "C:\ProgramData\chocolatey\lib\MEGAcmd\tools\mega-cmd.exe"

        if (!(Test-Path $mega)) {
          Write-Error "MEGAcmd nu a fost gasit"
          exit 1
        }

        & $mega login ${{ secrets.MEGA_EMAIL }} ${{ secrets.MEGA_PASSWORD }}

        if (!(Test-Path "C:\RDP_Work")) {
          New-Item -Path "C:\RDP_Work" -ItemType Directory
        }

        & $mega get /RDP_Backup C:\RDP_Work

        Write-Host "Restaurare finalizata."

    - name: 3. Configurare RDP + Ngrok
      shell: pwsh
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        net user runneradmin ParolaRDP123! /add
        net localgroup administrators runneradmin /add

        $ngrok = "C:\ProgramData\chocolatey\bin\ngrok.exe"
        & $ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

        Start-Process $ngrok -ArgumentList "tcp 3389"

    - name: 4. Afisare RDP + Auto Backup
      shell: pwsh
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        Start-Sleep -Seconds 30

        $tunnels = Invoke-RestMethod http://localhost:4040/api/tunnels

        Write-Host "=========================================="
        Write-Host "ADRESA RDP: $($tunnels.tunnels[0].public_url)"
        Write-Host "USER: runneradmin"
        Write-Host "PAROLA: ParolaRDP123!"
        Write-Host "=========================================="

        $mega = "C:\ProgramData\chocolatey\lib\MEGAcmd\tools\mega-cmd.exe"
        $count = 0

        while ($count -lt 18) {
          Start-Sleep -Seconds 600
          & $mega put -c C:\RDP_Work /RDP_Backup
          $count++
        }

        gh api repos/${{ github.repository }}/dispatches -f event_type=restart_rdp
